var app=angular.module("travelApp",["ui.router","templates","ui.bootstrap"]);app.config(["$stateProvider","$urlRouterProvider",function(e,t){t.otherwise("/login"),e.state("login",{url:"/login",views:{header:{templateUrl:"header/auth-header.html"},page:{templateUrl:"login/login.html",controller:"loginController"}}}).state("register",{url:"/register",views:{header:{templateUrl:"header/auth-header.html"},page:{templateUrl:"register/register.html",controller:"registerController"}}}).state("forgot",{url:"/forgot",views:{header:{templateUrl:"header/auth-header.html"},page:{templateUrl:"forgotPassword/forgotpassword.html",controller:"forgotPasswordController"}}}).state("dashboard",{url:"/dashboard",views:{header:{templateUrl:"header/home-header.html",controller:"headerController"},page:{templateUrl:"dashboard/dashboard.html",controller:"dashboardController"},footer:{templateUrl:"footer/footer.html"}}}).state("request",{url:"/request",views:{header:{templateUrl:"header/home-header.html",controller:"headerController"},page:{templateUrl:"request/request.html",controller:"requestController"},footer:{templateUrl:"footer/footer.html"}}}).state("request.regular",{url:"/regular",templateUrl:"request/regular/regular-request.html",controller:"regularListController"}).state("request.fixed",{url:"/fixed",templateUrl:"request/fixed/fixed-request.html",controller:"fixedListController"}).state("request.all",{url:"/all",templateUrl:"request/all/all-request.html",controller:"allListController"}).state("package",{url:"/package",views:{header:{templateUrl:"header/home-header.html",controller:"headerController"},page:{templateUrl:"package/package.html",controller:"packageController"},footer:{templateUrl:"footer/footer.html"}}}).state("package.local",{url:"/local",templateUrl:"package/local/local-package.html",controller:"localPackageController"}).state("package.out",{url:"/out",templateUrl:"package/out/out-package.html",controller:"outPackageController"}).state("package.fix",{url:"/fix",templateUrl:"package/fix/fix-package.html",controller:"fixPackageController"}).state("vehicle",{url:"/vehicle",views:{header:{templateUrl:"header/home-header.html",controller:"headerController"},page:{templateUrl:"vehicle/vehicle.html",controller:"vehicleController"},footer:{templateUrl:"footer/footer.html"}}}).state("vehicle.own",{url:"/own",templateUrl:"vehicle/own/own-vehicle.html",controller:"ownVehicleController"}).state("vehicle.other",{url:"/other",templateUrl:"vehicle/other/other-vehicle.html",controller:"otherVehicleController"}).state("driver",{url:"/driver",views:{header:{templateUrl:"header/home-header.html",controller:"headerController"},page:{templateUrl:"driver/driver.html",controller:"driverController"},footer:{templateUrl:"footer/footer.html"}}}).state("party",{url:"/party",views:{header:{templateUrl:"header/home-header.html",controller:"headerController"},page:{templateUrl:"party/party.html",controller:"partyController"},footer:{templateUrl:"footer/footer.html"}}}).state("party.client",{url:"/client",templateUrl:"party/client/client.html",controller:"clientController"}).state("party.operator",{url:"/operator",templateUrl:"party/operator/operator.html",controller:"operatorController"}).state("expense",{url:"/expense",views:{header:{templateUrl:"header/home-header.html",controller:"headerController"},page:{templateUrl:"expense/expense.html",controller:"expenseController"},footer:{templateUrl:"footer/footer.html"}}}).state("expense.vehicle",{url:"/vehicle",templateUrl:"expense/vehicle/vehicle-expense.html",controller:"vehicleExpenseController"}).state("expense.driver",{url:"/driver",templateUrl:"expense/driver/driver-expense.html",controller:"driverExpenseController"}).state("payment",{url:"/payment",views:{header:{templateUrl:"header/home-header.html",controller:"headerController"},page:{templateUrl:"payment/payment.html",controller:"paymentController"},footer:{templateUrl:"footer/footer.html"}}}).state("payment.fixed",{url:"/fixed",templateUrl:"payment/fixed/fixed-payment.html",controller:"fixedPaymentController"}).state("payment.client",{url:"/client",templateUrl:"payment/client/client-payment.html",controller:"clientPaymentController"}).state("payment.operator",{url:"/operator",templateUrl:"payment/operator/operator-payment.html",controller:"operatorPaymentController"}).state("payment.indirect",{url:"/indirect",templateUrl:"payment/indirect/indirect-payment.html",controller:"indirectPaymentController"}).state("payment.driver",{url:"/driver",templateUrl:"payment/driver/driver-payment.html",controller:"driverPaymentController"}).state("summary",{url:"/summary",views:{header:{templateUrl:"header/home-header.html",controller:"headerController"},page:{templateUrl:"summary/summary.html",controller:"summaryController"},footer:{templateUrl:"footer/footer.html"}}}).state("summary.vehicle",{url:"/vehicle",templateUrl:"summary/vehicle/vehicle-summary.html",controller:"vehicleSummaryController"}).state("summary.driver",{url:"/driver",templateUrl:"summary/driver/driver-summary.html",controller:"driverSummaryController"})}]),app.controller("changePassword",["$scope",function(e){}]),app.factory("authService",["$q","config",function(e,t,a){return{session:!1,validateUser:function(e){return a.getData(a.login,'f={"id":1}&q='+e)}}}]),app.factory("calculation",[function(){return{convertIntoDate:function(e){return e.getFullYear()+"/"+(e.getMonth()+1)+"/"+e.getDate()},convertIntoTime:function(e){return e.getHours()+":"+e.getMinutes()+":"+e.getSeconds()},duration:function(e,t,a,r){var n=this.convertIntoDate(e),l=this.convertIntoTime(a),o=new Date(n+" "+l),i=this.convertIntoDate(t),c=this.convertIntoTime(r),s=new Date(i+" "+c);return s-o}}}]),app.factory("config",["$http",function(e){var t=!1;return{local:t,apiKey:"NNY26lvUYux1Rz5H-7QLgNB28lsBmg0K",baseUrl:t?"http://localhost:9090/api/travel":"v1/api/1/databases/travel/collections",login:"/login",regular:"/request",fixed:"/fixedRequest","package":"/packages",vehicle:"/vehicles",party:"/party",driver:"/drivers",vehicleExpense:"/expense",driverExpense:"/driverExpense",months:["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"],years:function(){for(var e=[],t=(new Date).getFullYear(),a=2015;a<t+1;a++)e.push(a);return e},inWords:function(e){var t=["","thousand","million","billion","trillion"],a=["zero","one","two","three","four","five","six","seven","eight","nine"],r=["ten","eleven","twelve","thirteen","fourteen","fifteen","sixteen","seventeen","eighteen","nineteen"],n=["twenty","thirty","forty","fifty","sixty","seventy","eighty","ninety"];if(e=e.toString(),e=e.replace(/[\, ]/g,""),e!=parseFloat(e))return"not a number";var l=e.indexOf(".");if(l==-1&&(l=e.length),l>15)return"too big";for(var o=e.split(""),i="",c=0,s=0;s<l;s++)(l-s)%3==2?"1"==o[s]?(i+=r[Number(o[s+1])]+" ",s++,c=1):0!=o[s]&&(i+=n[o[s]-2]+" ",c=1):0!=o[s]&&(i+=a[o[s]]+" ",(l-s)%3==0&&(i+="hundred "),c=1),(l-s)%3==1&&(c&&(i+=t[(l-s-1)/3]+" "),c=0);if(l!=e.length){var u=e.length;i+="point ";for(var s=l+1;s<u;s++)i+=a[o[s]]+" "}return i.replace(/\s+/g," ")},guid:function(){function e(){return Math.floor(65536*(1+Math.random())).toString(16).substring(1)}return e()+e()+"-"+e()+"-"+e()+"-"+e()+"-"+e()+e()+e()},getData:function(t,a){return this.local?e.get(this.baseUrl+t+"?"+a):e.get(this.baseUrl+t+"?apiKey="+this.apiKey+"&"+a)},postData:function(t,a){return this.local?e.post(this.baseUrl+t,JSON.stringify(a)):e.post(this.baseUrl+t+"?apiKey="+this.apiKey,JSON.stringify(a))},updateData:function(t,a,r){return this.local?e.put(this.baseUrl+t+"?q="+a,JSON.stringify(r)):e.put(this.baseUrl+t+"?apiKey="+this.apiKey+"&q="+a,JSON.stringify(r))},deleteData:function(t,a){return this.local?e["delete"](this.baseUrl+""+t+"/"+a+"?c=true"):e["delete"](this.baseUrl+""+t+"/"+a+"?c=true&apiKey="+this.apiKey)}}}]),app.constant("gridMap",{PACKAGE:[{name:"Package Code",hideOn:"phone",map:"packageCode"},{name:"Basic Amount",map:"basicAmt",type:"amount"},{name:"Minimum KMs",map:"kmRate.minKm"},{name:"Minimum Hours",map:"hrRate.minHr"},{name:"Extra KM Rate",map:"kmRate.extraKm",type:"amount",hideOn:"phone,tablet"},{name:"Extra HR Rate",map:"hrRate.extraHr",type:"amount",hideOn:"phone,tablet"}],VEHICLE:{OWN:[{name:"Vehicle No.",map:"vehicleNo"},{name:"Vehicle Name",hideOn:"phone,tablet",map:"vehicleName"},{name:"Vehicle owner",hideOn:"phone",map:"vehicleOwner"},{name:"Vehicle Type",hideOn:"phone,tablet",map:"vehicleType"},{name:"Loan",type:"amount",map:"loan.loanAmt"},{name:"Fixed To Company",map:"selectFixed"}],OTHER:[{name:"Vehicle No.",map:"vehicleNo"},{name:"Vehicle Name",hideOn:"phone",map:"vehicleName"},{name:"Vehicle owner",map:"vehicleOwner"},{name:"Vehicle Type",hideOn:"phone",map:"vehicleType"}]},PARTY:{CLIENT:[{name:"Party Name",map:"name"},{name:"Party Address",hideOn:"phone,tablet",map:"address"},{name:"Party Contact",type:"phone",map:"contact"},{name:"Party Email",hideOn:"phone,tablet",map:"email"},{name:"Comments",hideOn:"phone,tablet",map:"comments"}],OPERATOR:[{name:"Operator Name",map:"name"},{name:"Operator Address",map:"address",hideOn:"phone,tablet"},{name:"Operator contact",map:"contact",type:"phone"},{name:"Operator Email",map:"email",hideOn:"phone,tablet"},{name:"Vehicle",map:"vehicle",hideOn:"phone,tablet",type:"repeat"},{name:"Comments",map:"comments",hideOn:"phone,tablet"}]}}),app.directive("responsiveGrid",["$timeout",function(e){return function(t,a,r){var n=$(a).parent().parent();t.$last&&!n.hasClass("footable-loaded")&&e(function(){n.footable()},10),t.$last&&n.hasClass("footable-loaded")&&e(function(){n.trigger("footable_redraw")},10)}}]),app.directive("grid",["config",function(e){return{restrict:"AE",templateUrl:"common/grid.html",replace:!0,scope:{datasource:"=",gridconfig:"=",viewData:"&view",editData:"&edit",deleteData:"&delete"},controller:["$scope",function(t){t.localEnv=e.local,t.gridData=t.gridconfig,t.$watch("datasource",function(){t.data=t.datasource})}]}}]),app.directive("number",function(){var e=/^\-?\d+$/;return{restrict:"A",require:"ngModel",link:function(t,a,r,n){n.$validators.number=function(t,a){return e.test(a)}}}}),app.controller("deleteConfirmationController",["$scope","message","$uibModalInstance",function(e,t,a){e.closeModal=function(){a.close(!1)},e.onConfirm=function(){a.close(!0)}}]),app.controller("messageController",["$scope","message","$uibModalInstance",function(e,t,a){e.msg=t,e.closeModal=function(){a.close()}}]),app.service("messageService",["$uibModal",function(e){this.showMessage=function(t){e.open({templateUrl:"common/modal/message.html",controller:"messageController",size:"md",resolve:{message:function(){return t}}})},this.deleteConfirm=function(t){return e.open({templateUrl:"common/modal/deleteConfirmation.html",controller:"deleteConfirmationController",size:"sm",resolve:{message:function(){return t}}})}}]),app.factory("pdfService",[function(){return{buildPDF:function(e,t,a,r,n,l){var o=new jsPDF({unit:"pt",lineHeight:1.5,orientation:"l"});o.setFont("helvetica"),o.setFontSize(14),o.text(a,10,20),l&&(o.setFontSize(11),o.text(l,10,40)),o.autoTable(e,t,{theme:"grid",styles:{font:"helvetica",overflow:"linebreak"},bodyStyles:{valign:"top"},headerStyles:{fillColor:[0,186,139]},columnStyles:{},margin:{top:l?50:30,left:10,right:10,bottom:10},createdCell:function(e,t){n&&t.column.dataKey===n&&(e.styles.halign="right")}}),o.save(r+".pdf")}}}]),app.controller("dashboardController",["$scope","$q","driverService","packageService","vehicleService","partyService",function(e,t,a,r,n,l){e.currDate=new Date}]),app.controller("driverController",["$scope","$state","$rootScope","driverService","messageService","config","$uibModal",function(e,t,a,r,n,l,o){e.data=[],e.loading=!0,e.localEnv=l.local;var i=function(){r.getDriver().then(s,function(){t.go("login")})},c=function(e,t){o.open({templateUrl:"driver/driver-modal.html",controller:"driverModalController",size:"lg",resolve:{record:function(){return{action:e,data:t}}}})},s=function(t){e.data=t.data,r.driver||(r.driver=t.data),e.loading=!1};a.$on("driver",function(){i()}),i(),e.addDriver=function(){c("new",{})},e.viewRequest=function(e){c("view",r.filterRecord(e)[0])},e.editRequest=function(e){c("edit",r.filterRecord(e)[0])},e.deleteRequest=function(t){n.deleteConfirm().result.then(function(a){a&&e.deleteRecord(t)})},e.deleteRecord=function(e){var t=r.filterRecord(e)[0].name;r.deleteDriver(e).then(function(e){r.driver=null,i(),n.showMessage({type:"success",title:"Driver",text:"Driver "+t+" Deleted successfully."})},function(){n.showMessage({type:"error",title:"Driver",text:"Driver "+t+" can not be deleted at this time. Please try again."})})}}]),app.controller("driverModalController",["$scope","$rootScope","$uibModalInstance","driverService","messageService","record",function(e,t,a,r,n,l){"use strict";if(e.driver=angular.copy(l.data),e.action=l.action,e.driver.joinDate="new"===e.action?new Date:new Date(e.driver.joinDate),"edit"===e.action)var o=e.driver._id;e.calendar={open:!1},e.loading=!1,e.hideView="view"===e.action,e.openCalendar=function(){e.calendar.open=!0},e.closeModal=function(){a.close()},e.submitRequest=function(){e.loading=!0,"new"===l.action?r.addDriver(e.driver).then(function(){e.closeModal(),r.driver=null,t.$emit("driver"),n.showMessage({type:"success",title:"Driver",text:"New driver added successfully."})},function(){n.showMessage({type:"error",title:"Driver",text:"Driver not added successfully. Please try again."})}):(delete e.driver._id,r.updateDriver(o,e.driver).then(function(){e.closeModal(),r.driver=null,t.$emit("driver"),n.showMessage({type:"success",title:"Driver",text:"Driver updated successfully."})},function(e){n.showMessage({type:"error",title:"Driver",text:"Driver not updated successfully. Please try again."})}))}}]),app.factory("driverService",["$filter","$q","config",function(e,t,a){return{driver:null,filterRecord:function(t){return e("filter")(this.driver,{_id:a.local?t:{$oid:t}})},getDriver:function(){return this.driver?t.resolve({data:this.driver}):a.getData(a.driver,"q={}")},addDriver:function(e){return a.postData(a.driver,e)},updateDriver:function(e,t){var r=a.local?'{"_id":"'+e+'"}':'{"_id":{"$oid":"'+e.$oid+'"}}';return a.updateData(a.driver,r,{$set:t})},deleteDriver:function(e){return a.deleteData(a.driver,e)}}}]),app.controller("addDriverExpenseController",["$scope","$rootScope","$filter","$uibModalInstance","expenseService","driverService","messageService","record",function(e,t,a,r,n,l,o,i){if(e.expense=angular.copy(i.data),e.action=i.action,e.expense.date="new"===e.action?new Date:new Date(e.expense.date),"edit"===e.action)var c=e.expense._id;e.loading=!1,e.hideView="view"===e.action,e.calendar={},e.openCalendar=function(){e.calendar.open=!0},e.closeModal=function(){r.close()},l.getDriver().then(function(t){e.driverList=t.data,l.driver||(l.driver=t.data)}),e.submitRequest=function(){e.expense.month=a("date")(e.expense.date,"MMM"),e.expense.year=a("date")(e.expense.date,"yyyy"),e.loading=!0,"new"===e.action?n.addExpense("driverExpense",e.expense).then(function(){e.closeModal(),n.expense.driverExpense=null,t.$emit("driverExpense"),o.showMessage({type:"success",title:"Driver Expense",text:"New driver expense added successfully."})},function(){o.showMessage({type:"error",title:"Driver Expense",text:"Driver expense not added successfully. Please try again."})}):(delete e.expense._id,n.updateExpense("driverExpense",c,e.expense).then(function(){e.closeModal(),n.expense.driverExpense=null,t.$emit("driverExpense"),o.showMessage({type:"success",title:"driver Expense",text:"Driver expense updated successfully."})},function(e){o.showMessage({type:"error",title:"Driver Expense",text:"Driver expense not updated successfully. Please try again."})}))}}]),app.controller("driverExpenseController",["$scope","$state","$rootScope","$filter","expenseService","requestService","driverService","messageService","pdfService","$uibModal","config",function(e,t,a,r,n,l,o,i,c,s,u){e.data=[],e.loading=!0,e.localEnv=u.local,e.currMonth=(new Date).getMonth(),e.monthList=u.months,e.filter={},e.filter.month=e.monthList[e.currMonth];var d,p=function(){e.loading=!1,e.totalItems=e.data.length,e.currentPage=l.request.pager.currentPage,e.itemsPerPage=l.request.pager.itemsPerPage,e.maxSize=l.request.pager.maxSize},h=function(t){e.data=t.data,d=angular.copy(e.data),n.expense.driverExpense||(n.expense.driverExpense=t.data),e.loading=!1,p()},f=function(e,t){s.open({templateUrl:"expense/driver/add-driver-expense.html",controller:"addDriverExpenseController",size:"lg",resolve:{record:function(){return{action:e,data:t}}}})},m=function(){n.getExpense("driverExpense",'s={"date":-1}').then(h,function(){t.go("login")})};m(),a.$on("driverExpense",function(){m()}),o.getDriver().then(function(t){e.driverList=t.data,o.driver||(o.driver=t.data)}),e.applyFilter=function(){e.data=r("filter")(d,{driver:e.filter.driver,month:e.filter.month})},e.clearFilter=function(){e.data=d,e.filter.driver="",e.filter.month=e.monthList[e.currMonth]},e.newExpense=function(){f("new",{})},e.viewRequest=function(e){f("view",n.filterRecord("driverExpense",e)[0])},e.editRequest=function(e){f("edit",n.filterRecord("driverExpense",e)[0])},e.deleteRequest=function(t){i.deleteConfirm().result.then(function(a){a&&e.deleteRecord(t)})},e.deleteRecord=function(e){n.deleteExpense("driverExpense",e).then(function(){n.expense.driverExpense=null,m(),i.showMessage({type:"success",title:"Driver Expense",text:"Driver expense deleted successfully."})},function(){i.showMessage({type:"error",title:"Driver Expense",text:"Driver expense not deleted successfully. Please try again."})})},e.buildData=function(e){for(var t=[],a=0;a<e.length;a++){var n=[a+1,r("date")(e[a].date,"dd-MMM-yyyy"),e[a].driver,r("number")(e[a].expenseAmt,"2")+"/-",r("number")(e[a].tollExpenseAmt,"2")+"/-",r("number")(e[a].expenseAmt+e[a].tollExpenseAmt,"2")+"/-",e[a].comments];t.push(n)}return t},e.exportData=function(){var t=["Sr. No","Date","Driver","Self Advanced","Toll Advanced","Total Advanced","Comments"];c.buildPDF(t,e.buildData(e.data),"Driver Expenses","Driver_expense")}}]),app.controller("expenseController",["$scope",function(e){}]),app.factory("expenseService",["$uibModal","$filter","$q","config",function(e,t,a,r){return{expense:{vehicleExpense:null,driverExpense:null},filterRecord:function(e,a){return t("filter")(this.expense[e],{_id:r.local?a:{$oid:a}})},getExpense:function(e,t){return this.expense[e]?a.resolve({data:this.expense[e]}):r.getData(r[e],t)},addExpense:function(e,t){return r.postData(r[e],t)},updateExpense:function(e,t,a){var n=r.local?'{"_id":"'+t+'"}':'{"_id":{"$oid":"'+t.$oid+'"}}';return r.updateData(r[e],n,{$set:a})},deleteExpense:function(e,t){return r.deleteData(r[e],t)}}}]),app.controller("addVehicleExpenseController",["$scope","$rootScope","$filter","$uibModalInstance","expenseService","vehicleService","messageService","record",function(e,t,a,r,n,l,o,i){if(e.expense=angular.copy(i.data),e.action=i.action,e.expense.date="new"===e.action?new Date:new Date(e.expense.date),"new"===e.action&&(e.expense.paymentMode="cash"),"edit"===e.action)var c=e.expense._id;e.loading=!1,e.hideView="view"===e.action,e.calendar={},e.openCalendar=function(){e.calendar.open=!0},e.closeModal=function(){r.close()},l.getVehicle("own").then(function(t){e.vehicleList=t.data[0].data,l.vehicle.own||(l.vehicle.own=t.data)}),e.submitRequest=function(){e.expense.month=a("date")(e.expense.date,"MMM"),e.expense.year=a("date")(e.expense.date,"yyyy"),e.loading=!0,"new"===e.action?n.addExpense("vehicleExpense",e.expense).then(function(){e.closeModal(),n.expense.vehicleExpense=null,t.$emit("vehicleExpense"),o.showMessage({type:"success",title:"Vehicle Expense",text:"New vehicle expense added successfully."})},function(){o.showMessage({type:"error",title:"Vehicle Expense",text:"Vehicle expense not added successfully. Please try again."})}):(delete e.expense._id,n.updateExpense("vehicleExpense",c,e.expense).then(function(){e.closeModal(),n.expense.vehicleExpense=null,t.$emit("vehicleExpense"),o.showMessage({type:"success",title:"Vehicle Expense",text:"Vehicle expense updated successfully."})},function(e){o.showMessage({type:"error",title:"Vehicle Expense",text:"Vehicle expense not updated successfully. Please try again."})}))}}]),app.controller("vehicleExpenseController",["$scope","$state","$rootScope","$filter","expenseService","requestService","vehicleService","messageService","pdfService","$uibModal","config",function(e,t,a,r,n,l,o,i,c,s,u){e.data=[],e.loading=!0,e.localEnv=u.local,e.currMonth=(new Date).getMonth(),e.monthList=u.months,e.filter={},e.filter.month=e.monthList[e.currMonth];var d,p=function(){e.loading=!1,e.totalItems=e.data.length,e.currentPage=l.request.pager.currentPage,e.itemsPerPage=l.request.pager.itemsPerPage,e.maxSize=l.request.pager.maxSize},h=function(t){e.data=t.data,d=angular.copy(e.data),n.expense.vehicleExpense||(n.expense.vehicleExpense=t.data),e.loading=!1,p()},f=function(e,t){s.open({templateUrl:"expense/vehicle/add-vehicle-expense.html",controller:"addVehicleExpenseController",size:"lg",resolve:{record:function(){return{action:e,data:t}}}})},m=function(){n.getExpense("vehicleExpense",'s={"date":-1}').then(h,function(){t.go("login")})},v=function(e){return"fuel"==e.expenseName?e.expenseName.toUpperCase()+", Fule Rate : "+e.fuelRate+"\n Current KM : "+e.currKm:e.expenseName.toUpperCase()},g=function(e){return"credit"==e.paymentMode?"CREDIT \n CARD NO: "+e.credit.cardName:"cheque"==e.paymentMode?"CHEQUE \n BANK NAME: "+e.cheque.bankName:e.paymentMode.toUpperCase()},y=function(e){for(var t=[],a=0;a<e.length;a++){var n=[a+1,r("date")(e[a].date,"dd-MMM-yyyy"),v(e[a]),e[a].location,e[a].vehicle,r("number")(e[a].expenseAmt,"2")+"/-",g(e[a]),e[a].comments];t.push(n)}return t};m(),a.$on("vehicleExpense",function(){m()}),o.getVehicle("own").then(function(t){e.vehicleList=t.data[0].data,o.vehicle.own||(o.vehicle.own=t.data)}),e.applyFilter=function(){e.data=r("filter")(d,{vehicle:e.filter.vehicle,month:e.filter.month})},e.clearFilter=function(){e.data=d,e.filter.vehicle="",e.filter.month=e.monthList[e.currMonth]},e.newExpense=function(){f("new",{})},e.viewRequest=function(e){f("view",n.filterRecord("vehicleExpense",e)[0])},e.editRequest=function(e){f("edit",n.filterRecord("vehicleExpense",e)[0])},e.deleteRequest=function(t){i.deleteConfirm().result.then(function(a){a&&e.deleteRecord(t)})},e.deleteRecord=function(e){n.deleteExpense("vehicleExpense",e).then(function(){n.expense.vehicleExpense=null,m(),i.showMessage({type:"success",title:"Vehicle Expense",text:"Vehicle expense deleted successfully."})},function(){i.showMessage({type:"error",title:"Vehicle Expense",text:"Vehicle expense not deleted successfully. Please try again."})})},e.exportData=function(){var t=["Sr. No","Date","Expense Type","Location","Vehicle","Expense Amount","Payment Mode","Comments"];c.buildPDF(t,y(e.data),"Vehicle Expenses","Vehicle_expense",5)}}]),app.controller("forgotPasswordController",["$scope","$http",function(e,t){e.email="",e.submit=function(){t.get("/forgotPassword?email="+e.email).then(function(e){console.log("SUCCESS")},function(){console.log("ERROR")})}}]),app.controller("headerController",["$scope","$state","$http","requestService","vehicleService","packageService","driverService","partyService","expenseService",function(e,t,a,r,n,l,o,i,c){e.logOut=function(){r.request.regular=null,r.request.fixed=null,l["package"].local=null,l["package"].out=null,l["package"].fix=null,n.vehicle.own=null,n.vehicle.other=null,o.driver=null,i.party.client=null,i.party.operator=null,c.expense.vehicleExpense=null,c.expense.driverExpense=null,a.get("/logout").then(function(e){t.go("login")},function(){console.log("ERROR")})}}]),app.controller("loginController",["$http","$scope","$state","authService",function(e,t,a,r){"use strict";t.loginData={userName:"",password:""},t.showAlert=!1,t.loading=!1,t.signIn=function(){t.loading=!0,e.get("/login?userName="+t.loginData.userName+"&password="+t.loginData.password).then(function(e){t.loading=!1,t.showAlert=!1,a.go("request.regular")},function(){t.loading=!1,t.showAlert=!0})}}]),app.controller("fixPackageController",["$scope","$state","$rootScope","$uibModal","packageService","messageService","gridMap",function(e,t,a,r,n,l,o){e.data=[],e.gridConfig=o.PACKAGE,e.loading=!0;var i=function(t){e.data=t.data[0].data,n["package"].fix||(n["package"].fix=t.data),e.loading=!1},c=function(){n.getPackage("fix").then(i,function(){t.go("login")})},s=function(e,t){r.open({templateUrl:"package/package-modal.html",controller:"packageModalController",size:"lg",resolve:{record:function(){return{action:e,type:"fix",data:t}}}})};a.$on("fixPackage",function(){c()}),c(),e.newPackage=function(){s("new",{})},e.view=function(e){s("view",n.filterRecord("fix",e)[0])},e.edit=function(e){s("edit",n.filterRecord("fix",e)[0])},e["delete"]=function(t){l.deleteConfirm().result.then(function(a){a&&e.deleteRecord(t)})},e.deleteRecord=function(e){var t=n.filterRecord("fix",e)[0].packageCode;n.deletePackage('{"name":"fix"}',e).then(function(){n["package"].fix=null,c(),l.showMessage({type:"success",title:"Package",text:"Package "+t+" Deleted successfully."})},function(){l.showMessage({type:"error",title:"Package",text:"Package "+t+" can not be deleted at this time. Please try again."})})}}]),app.controller("localPackageController",["$scope","$state","$rootScope","$uibModal","packageService","messageService","gridMap",function(e,t,a,r,n,l,o){e.data=[],e.gridConfig=o.PACKAGE,e.loading=!0;var i=function(t){e.data=t.data[0].data,n["package"].local||(n["package"].local=t.data),e.loading=!1},c=function(){n.getPackage("local").then(i,function(){t.go("login")})},s=function(e,t){r.open({templateUrl:"package/package-modal.html",controller:"packageModalController",size:"lg",resolve:{record:function(){return{action:e,type:"local",data:t}}}})};a.$on("localPackage",function(){c()}),c(),e.newPackage=function(){s("new",{})},e.view=function(e){s("view",n.filterRecord("local",e)[0])},e.edit=function(e){s("edit",n.filterRecord("local",e)[0])},e["delete"]=function(t){l.deleteConfirm().result.then(function(a){a&&e.deleteRecord(t)})},e.deleteRecord=function(e){var t=n.filterRecord("local",e)[0].packageCode;n.deletePackage('{"name":"local"}',e).then(function(){n["package"].local=null,c(),l.showMessage({type:"success",title:"Package",text:"Package "+t+" Deleted successfully."})},function(){l.showMessage({type:"error",title:"Package",text:"Package "+t+" can not be deleted at this time. Please try again."})})}}]),app.controller("outPackageController",["$scope","$rootScope","$uibModal","packageService","messageService","gridMap",function(e,t,a,r,n,l){e.data=[],e.gridConfig=l.PACKAGE,e.loading=!0;var o=function(t){e.data=t.data[0].data,r["package"].out||(r["package"].out=t.data),e.loading=!1},i=function(){r.getPackage("out").then(o,function(){$state.go("login")})},c=function(e,t){a.open({templateUrl:"package/package-modal.html",controller:"packageModalController",size:"lg",resolve:{record:function(){return{action:e,type:"out",data:t}}}})};t.$on("outPackage",function(){i()}),i(),e.newPackage=function(){c("new",{})},e.view=function(e){c("view",r.filterRecord("out",e)[0])},e.edit=function(e){c("edit",r.filterRecord("out",e)[0])},e["delete"]=function(t){n.deleteConfirm().result.then(function(a){a&&e.deleteRecord(t)})},e.deleteRecord=function(e){var t=r.filterRecord("out",e)[0].packageCode;r.deletePackage('{"name":"out"}',e).then(function(){r["package"].out=null,i(),n.showMessage({type:"success",title:"Package",text:"Package "+t+" Deleted successfully."})},function(){n.showMessage({type:"error",title:"Package",text:"Package "+t+" can not be deleted at this time. Please try again."})})}}]),app.controller("packageController",["$scope",function(e){}]),app.controller("packageModalController",["$scope","$rootScope","$uibModalInstance","packageService","messageService","record",function(e,t,a,r,n,l){"use strict";e["package"]=angular.copy(l.data),e.action=l.action,e.type=l.type,e.loading=!1,e.hideView="view"===e.action,e.closeModal=function(){a.close()},e.submitRequest=function(){e.loading=!0,"new"===l.action?r.addPackage('{"name":"'+e.type+'"}',e["package"]).then(function(){e.closeModal(),r["package"][e.type]=null,t.$emit(e.type+"Package"),n.showMessage({type:"success",title:"Package",text:"New "+e.type+" package added successfully."})},function(){n.showMessage({type:"error",title:"Package",text:e.type+" package not added successfully. Please try again."})}):r.updatePackage('{"name":"'+e.type+'","data._id":"'+e["package"]._id+'"}',e["package"]).then(function(){e.closeModal(),r["package"][e.type]=null,t.$emit(e.type+"Package"),n.showMessage({type:"success",title:"Package",text:"New "+e.type+" package updated successfully."})},function(t){n.showMessage({type:"error",title:"Package",text:e.type+" package not updated successfully. Please try again."})})}}]),app.factory("packageService",["$uibModal","$filter","$q","config",function(e,t,a,r){return{"package":{local:null,out:null,fix:null},filterRecord:function(e,a){return t("filter")(this["package"][e][0].data,{_id:a})},getPackage:function(e){return this["package"][e]?a.resolve({data:this["package"][e]}):r.getData(r["package"],'q={"name":"'+e+'"}')},addPackage:function(e,t){return t._id=r.guid(),r.updateData(r["package"],e,{$push:{data:t}})},updatePackage:function(e,t){return r.updateData(r["package"],e,{$set:{"data.$":t}})},deletePackage:function(e,t){var a={_id:t};return r.updateData(r["package"],e,{$pull:{data:a}})}}}]),app.controller("clientController",["$scope","$state","$rootScope","$uibModal","partyService","messageService","gridMap",function(e,t,a,r,n,l,o){e.data=[],e.gridConfig=o.PARTY.CLIENT,e.loading=!0;var i=function(t){e.data=t.data[0].data,n.party.client||(n.party.client=t.data),e.loading=!1},c=function(){n.getParty("client").then(i,function(){t.go("login")})},s=function(e,t){r.open({templateUrl:"party/party-modal.html",controller:"partyModalController",size:"lg",resolve:{record:function(){return{action:e,type:"client",data:t}}}})};a.$on("clientParty",function(){c()}),c(),e.newParty=function(){s("new",{})},e.view=function(e){s("view",n.filterRecord("client",e)[0])},e.edit=function(e){s("edit",n.filterRecord("client",e)[0])},e["delete"]=function(t){l.deleteConfirm().result.then(function(a){a&&e.deleteRecord(t)})},e.deleteRecord=function(e){var t=n.filterRecord("client",e)[0].name;n.deleteParty('{"name":"client"}',e).then(function(){n.party.client=null,c(),l.showMessage({type:"success",title:"Party",text:"Party "+t+" deleted successfully."})},function(){l.showMessage({type:"error",title:"Party",text:"Party "+t+" can not be deleted at this time. Please try again."})})}}]),app.controller("operatorController",["$scope","$state","$rootScope","$uibModal","partyService","messageService","gridMap",function(e,t,a,r,n,l,o){e.data=[],e.gridConfig=o.PARTY.OPERATOR,e.loading=!0;var i=function(t){e.data=t.data[0].data,n.party.operator||(n.party.operator=t.data),e.loading=!1},c=function(){n.getParty("operator").then(i,function(){t.go("login")})},s=function(e,t){r.open({templateUrl:"party/party-modal.html",controller:"partyModalController",size:"lg",resolve:{record:function(){return{action:e,type:"operator",data:t}}}})};a.$on("operatorParty",function(){c()}),c(),e.newOperator=function(){s("new",{})},e.view=function(e){s("view",n.filterRecord("operator",e)[0])},e.edit=function(e){s("edit",n.filterRecord("operator",e)[0])},e["delete"]=function(t){l.deleteConfirm().result.then(function(a){a&&e.deleteRecord(t)})},e.deleteRecord=function(e){var t=n.filterRecord("operator",e)[0].name;n.deleteParty('{"name":"operator"}',e).then(function(){n.party.operator=null,c(),l.showMessage({type:"success",title:"Operator",text:"Operator "+t+" deleted successfully."})},function(){l.showMessage({type:"error",title:"Operator",text:"Operator "+t+" can not be deleted at this time. Please try again."})})}}]),app.controller("partyController",["$scope",function(e){}]),
app.controller("partyModalController",["$scope","$rootScope","$uibModalInstance","partyService","messageService","record",function(e,t,a,r,n,l){"use strict";e.party=angular.copy(l.data),e.action=l.action,e.type=l.type,e.loading=!1,e.hideView="view"===e.action,e.closeModal=function(){a.close()},"operator"==e.type&&"new"===e.action&&(e.party.vehicle=[{name:"",number:""}]),e.addNewVehicle=function(){e.party.vehicle.push({name:"",number:""})},e.removeVehicle=function(t){e.party.vehicle.splice(t,1)},e.submitRequest=function(){e.loading=!0,"new"===e.action?r.addParty('{"name":"'+e.type+'"}',JSON.parse(angular.toJson(e.party))).then(function(){e.closeModal(),r.party[e.type]=null,t.$emit(e.type+"Party"),n.showMessage({type:"success",title:"Party",text:"New "+e.type+" party added successfully."})},function(){e.closeModal(),n.showMessage({type:"error",title:"Party",text:e.type+" party not added successfully. Please try again."})}):r.updateParty('{"name":"'+e.type+'","data._id":"'+e.party._id+'"}',JSON.parse(angular.toJson(e.party))).then(function(){e.closeModal(),r.party[e.type]=null,t.$emit(e.type+"Party"),n.showMessage({type:"success",title:"Party",text:"New "+e.type+" party updated successfully."})},function(t){e.closeModal(),n.showMessage({type:"error",title:"Party",text:e.type+" party not updated successfully. Please try again."})})}}]),app.factory("partyService",["$uibModal","$filter","$q","config",function(e,t,a,r){return{party:{client:null,operator:null},filterRecord:function(e,a){return t("filter")(this.party[e][0].data,{_id:a})},getParty:function(e){return this.party[e]?a.resolve({data:this.party[e]}):r.getData(r.party,'q={"name":"'+e+'"}')},addParty:function(e,t){return t._id=r.guid(),r.updateData(r.party,e,{$push:{data:t}})},updateParty:function(e,t){return r.updateData(r.party,e,{$set:{"data.$":t}})},deleteParty:function(e,t){var a={_id:t};return r.updateData(r.party,e,{$pull:{data:a}})}}}]),app.controller("clientPaymentController",["$scope","$q","$filter","config","partyService","requestService","pdfService",function(e,t,a,r,n,l,o){e.data=null,e.localEnv=r.local,e.loading=!1,e.currMonth=(new Date).getMonth(),e.monthList=r.months,e.yearList=r.years(),e.filter={},e.filter.year=(new Date).getFullYear().toString(),e.filter.month=e.monthList[e.currMonth],n.getParty("client").then(function(t){e.partyList=t.data[0].data,n.party.client||(n.party.client=t.data)});var i=function(t){e.partyTotal=0;for(var a=0;a<t.length;a++)e.partyTotal=e.partyTotal+t[a].totalAmt+t[a].tollAmt+t[a].parkingAmt},c=function(e){for(var t=[],r=0;r<e.length;r++){var n=[r+1,a("date")(e[r].startTrip.date,"dd-MMM-yyyy"),"local"===e[r].requestType?"Local":"Out Station","own"===e[r].vehicleSelect?e[r].vehicle.vehicle:"indirect"===e[r].vehicleSelect?e[r].inDirect.vehicle:"operator"===e[r].vehicleSelect?e[r].operator.vehicleName:e[r].agency.vehicleName,a("number")(e[r].totalAmt,"2")+"/-",a("number")(e[r].tollAmt,"2")+"/-",a("number")(e[r].parkingAmt,"2")+"/-",a("number")(e[r].totalAmt+e[r].tollAmt+e[r].parkingAmt,"2")+"/-"];t.push(n)}return t};e.calculatePayment=function(){e.data=[],e.loading=!0,l.request.regular?(e.data=a("filter")(l.request.regular,{selectClient:"party",partyName:e.filter.party,month:e.filter.month,year:e.filter.year}),e.loading=!1,i(e.data)):l.getRequest("regular",'q={"selectClient":"party","partyName":"'+e.filter.party+'","month":"'+e.filter.month+'","year":"'+e.filter.year+'"}&s={"startTrip.date":-1}').then(function(t){e.loading=!1,e.data=t.data,i(e.data)})},e.exportData=function(){var t=["Sr. No","Date","Request Type","Vehicle","Trip Amount","Toll Amount","Parking Amount","Total Amount"];o.buildPDF(t,c(e.data),"Client Payments","Client_Payments",0,"Party Name : "+e.filter.party+", Month : "+e.filter.month+",  Year : "+e.filter.year+"  ::  Total Amount : "+a("number")(e.partyTotal,"2")+"/-")}}]),app.controller("driverPaymentController",["$scope","$q","$filter","config","driverService","requestService","expenseService","pdfService",function(e,t,a,r,n,l,o,i){e.data=[],e.localEnv=r.local,e.loading=!0,e.currMonth=(new Date).getMonth(),e.monthList=r.months,e.yearList=r.years(),e.filter={},e.filter.year=(new Date).getFullYear().toString(),e.filter.month=e.monthList[e.currMonth];var c=function(t){return a("filter")(e.regularData,{vehicle:{driver:t},requestType:"local"}).length+a("filter")(e.fixedData,{driver:t,requestType:"local"}).length},s=function(t){return a("filter")(e.regularData,{vehicle:{driver:t},requestType:"out"}).length+a("filter")(e.fixedData,{driver:t,requestType:"out"}).length},u=function(t){for(var r=a("filter")(e.regularData,{vehicle:{driver:t}}),n=0,l=0;l<r.length;l++)n=n+r[l].driverAllowance+r[l].driverOverTime;return n},d=function(t){for(var r=a("filter")(e.fixedData,{driver:t}),n=0,l=0;l<r.length;l++)n=n+r[l].diverAllowanceAmt+r[l].driverOverTime+r[l].nightHaltAmt;return n},p=function(t){for(var r=a("filter")(e.expenseData,{driver:t}),n=0,l=0;l<r.length;l++)n+=r[l].expenseAmt;return n},h=function(e){return e.salary+e.allowance+e.fixrequestAmt-e.advanceAmt},f=function(){var r=t.defer();if(l.request.regular){var n=a("filter")(l.request.regular,{vehicleSelect:"own",month:e.filter.month,year:e.filter.year});r.resolve(n)}else l.getRequest("regular",'q={"vehicleSelect":"own","month":"'+e.filter.month+'","year":"'+e.filter.year+'"}').then(function(e){r.resolve(e.data)});return r.promise},m=function(){var a=t.defer();if(l.request.fixed){var r=l.request.fixed.filter(function(t){return("own"==t.regularVehicle&&"daily"==t.vehicleSelect||"own"==t.regularVehicle&&"own"==t.vehicleSelect||"indirect"==t.regularVehicle&&"own"==t.vehicleSelect)&&t.month==e.filter.month&&t.year==e.filter.year});a.resolve(r)}else l.getRequest("fixed",'q={"$or":[{"regularVehicle":"own","vehicleSelect":"daily"},{"regularVehicle":"own","vehicleSelect":"own"},{"regularVehicle":"indirect","vehicleSelect":"own"}],"month":"'+e.filter.month+'","year":"'+e.filter.year+'"}').then(function(e){a.resolve(e.data)});return a.promise},v=function(){var r=t.defer();if(o.expense.driverExpense){var n=a("filter")(o.expense.driverExpense,{month:e.filter.month,year:e.filter.year});r.resolve(n)}else o.getExpense("driverExpense",'q={"month":"'+e.filter.month+'","year":"'+e.filter.year+'"}').then(function(e){r.resolve(e.data)});return r.promise},g=function(e){for(var t=[],r=0;r<e.length;r++){var n=[r+1,e[r].name,a("number")(e[r].salary,"2")+"/-",e[r].localRequest,e[r].outRequest,a("number")(e[r].allowance+e[r].fixrequestAmt,"2")+"/-",a("number")(e[r].advanceAmt,"2")+"/-",a("number")(e[r].totalSalary,"2")+"/-"];t.push(n)}return t};e.calculatePayment=function(){e.data=[],e.loading=!0,t.all([f(),m(),v()]).then(function(t){e.regularData=t[0],e.fixedData=t[1],e.expenseData=t[2];for(var a=0;a<e.driverList.length;a++)e.driverList[a].localRequest=c(e.driverList[a].name),e.driverList[a].outRequest=s(e.driverList[a].name),e.driverList[a].allowance=u(e.driverList[a].name),e.driverList[a].fixrequestAmt=d(e.driverList[a].name),e.driverList[a].advanceAmt=p(e.driverList[a].name),e.driverList[a].totalSalary=h(e.driverList[a]);e.data=e.driverList,e.loading=!1})},n.getDriver().then(function(t){e.driverList=t.data,e.calculatePayment()}),e.exportData=function(){var t=["Sr. No","Driver Name","Base Salary","Local Requests","Out Requests","Total D.A.","Total Advanced","Total Salary"];i.buildPDF(t,g(e.data),"Driver Salary - "+e.filter.month+" "+e.filter.year,"Driver_Salary_"+e.filter.month+"_"+e.filter.year,0)}}]),app.controller("fixedPaymentController",["$scope","$q","$filter","config","vehicleService","partyService","requestService","packageService","pdfService",function(e,t,a,r,n,l,o,i,c){var s;e.data=null,e.localEnv=r.local,e.loading=!1,e.currMonth=(new Date).getMonth(),e.monthList=r.months,e.yearList=r.years(),e.filter={},e.filter.year=(new Date).getFullYear().toString(),e.filter.month=e.monthList[e.currMonth],t.all([n.getVehicle("own"),l.getParty("client")]).then(function(t){e.vehicleList=a("filter")(t[0].data[0].data,{selectFixed:"Yes"}),s=angular.copy(e.vehicleList),n.vehicle.own||(n.vehicle.own=t[0].data),e.partyList=t[1].data[0].data,l.party.client||(l.party.client=t[1].data)}),e.$watch("filter.party",function(t,r){e.filter.vehicle="",t&&(e.vehicleList=a("filter")(s,{fixed:{companyName:t}}))}),e.calculatePayment=function(){e.data=[],e.loading=!0,o.request.fixed?(e.data=a("filter")(o.request.fixed,{partyName:e.filter.party,vehicle:e.filter.vehicle,month:e.filter.month,year:e.filter.year}),e.loading=!1,u()):o.getRequest("fixed",'q={"partyName":"'+e.filter.party+'","vehicle":"'+e.filter.vehicle+'","month":"'+e.filter.month+'","year":"'+e.filter.year+'"}&s={"date":-1}').then(function(t){e.loading=!1,e.data=t.data,u()})};var u=function(){var t=a("filter")(s,{vehicleName:e.filter.vehicle.split(",")[0],vehicleNo:e.filter.vehicle.split(",")[1]})[0].fixed["package"];i.getPackage("fix").then(function(e){var r=a("filter")(e.data[0].data,{packageCode:t})[0];d(r)})},d=function(t){e.allData={basicAmt:t.basicAmt,basicKM:t.kmRate.minKm,extraKmRate:t.kmRate.extraKm,extraHrRate:t.hrRate.extraHr,totalKm:0,extraHr:0,DAAmt:0,DAAmtCount:0,nightHaltAmt:0,nightHaltAmtCount:0,overTimeAmt:0,tollAmt:0,parkingAmt:0,monthTotal:0};for(var a=0;a<e.data.length;a++)e.allData.totalKm+=e.data[a].totalKm,e.allData.extraHr+=e.data[a].extraHr,e.allData.DAAmt+=e.data[a].diverAllowanceAmt,e.data[a].diverAllowanceAmt>0&&e.allData.DAAmtCount++,e.allData.nightHaltAmt+=e.data[a].nightHaltAmt,e.data[a].nightHaltAmt>0&&e.allData.nightHaltAmtCount++,e.allData.overTimeAmt+=e.data[a].driverOverTime,e.allData.tollAmt+=e.data[a].tollAmt,e.allData.parkingAmt+=e.data[a].parkingAmt;e.allData.monthTotal=(e.allData.totalKm<=e.allData.basicKM?e.allData.basicAmt:e.allData.basicAmt+(e.allData.totalKm-e.allData.basicKM)*t.kmRate.extraKm)+e.allData.extraHr*t.hrRate.extraHr+e.allData.DAAmt+e.allData.nightHaltAmt+e.allData.tollAmt+e.allData.parkingAmt},p=function(e){for(var t=[],r=0;r<e.length;r++){var n=[r+1,a("date")(e[r].date,"dd-MMM-yyyy"),"local"==e[r].requestType?"Local":"Out Station",e[r].totalKm+" KM",e[r].extraHr+" Hr",a("number")(e[r].diverAllowanceAmt,"2")+"/-",a("number")(e[r].nightHaltAmt,"2")+"/-",a("number")(e[r].tollAmt,"2")+"/-",a("number")(e[r].parkingAmt,"2")+"/-"];t.push(n)}return t};e.exportData=function(){var t=["Sr. No","Date","Request Type","Trip KM","Extra Hours","Driver Allowance","Night Halt","Toll Amount","Parking Amount"];c.buildPDF(t,p(e.data),"Fixed Payments","Fixed_Payments",0,"Party Name : "+e.filter.party+",  Vehicle Name : "+e.filter.vehicle+",  Month : "+e.filter.month+",  Year : "+e.filter.year+"  ::  Total Amount : "+a("number")(e.allData.monthTotal,"2")+"/-")}}]),app.controller("indirectPaymentController",["$scope","$q","$filter","config","vehicleService","requestService","pdfService",function(e,t,a,r,n,l,o){e.data=null,e.localEnv=r.local,e.loading=!1,e.currMonth=(new Date).getMonth(),e.monthList=r.months,e.yearList=r.years(),e.filter={},e.filter.year=(new Date).getFullYear().toString(),e.filter.month=e.monthList[e.currMonth],n.getVehicle("other").then(function(t){e.vehicleList=t.data[0].data,n.vehicle.other||(n.vehicle.other=t.data)});var i=function(){var t;l.request.regular?(t=a("filter")(l.request.regular,{vehicleSelect:"indirect",inDirect:{vehicle:e.filter.vehicle},month:e.filter.month,year:e.filter.year}),c(t)):l.getRequest("regular",'q={"vehicleSelect":"indirect","inDirect.vehicle":"'+e.filter.vehicle+'","month":"'+e.filter.month+'","year":"'+e.filter.year+'"}').then(function(e){t=e.data,c(t)})},c=function(t){var r;l.request.fixed?(r=a("filter")(l.request.fixed,{vehicleSelect:"indirect",inDirect:{vehicle:e.filter.vehicle},month:e.filter.month,year:e.filter.year}),s(t,r)):l.getRequest("fixed",'q={"vehicleSelect":"indirect","inDirect.vehicle":"'+e.filter.vehicle+'","month":"'+e.filter.month+'","year":"'+e.filter.year+'"}').then(function(e){r=e.data,s(t,r)})},s=function(t,a){e.data=t.concat(a),e.loading=!1,e.indirectTotal=0;for(var r=0;r<e.data.length;r++)e.indirectTotal=e.indirectTotal+e.data[r].totalAmt+e.data[r].tollAmt+e.data[r].parkingAmt},u=function(e){for(var t=[],r=0;r<e.length;r++){var n=[r+1,a("date")(e[r].date?e[r].date:e[r].startTrip.date,"dd-MMM-yyyy"),"local"===e[r].requestType?"Local":"Out Station",a("number")(e[r].totalAmt,"2")+"/-",a("number")(e[r].tollAmt,"2")+"/-",a("number")(e[r].parkingAmt,"2")+"/-",a("number")(e[r].totalAmt+e[r].tollAmt+e[r].parkingAmt,"2")+"/-"];t.push(n)}return t};e.exportData=function(){var t=["Sr. No","Date","Request Type","Trip Amount","Toll Amount","Parking Amount","Total Amount"];o.buildPDF(t,u(e.data),"Indirect Payment - "+e.filter.month+" "+e.filter.year,"Indirect_Payment_"+e.filter.month+"_"+e.filter.year,0,"Party Name : "+e.filter.vehicle+", Month : "+e.filter.month+",  Year : "+e.filter.year+"  ::  Total Amount : "+a("number")(e.indirectTotal,"2")+"/-")},e.calculatePayment=function(){e.data=[],e.loading=!0,i()}}]),app.controller("operatorPaymentController",["$scope","$q","$filter","config","partyService","requestService","pdfService",function(e,t,a,r,n,l,o){e.data=[],e.localEnv=r.local,e.loading=!0,e.currMonth=(new Date).getMonth(),e.monthList=r.months,e.yearList=r.years(),e.filter={},e.filter.year=(new Date).getFullYear().toString(),e.filter.month=e.monthList[e.currMonth];var i=null,c=null,s=function(){var a=t.defer();if(l.request.regular){var r=l.request.regular.filter(function(t){return("operator"==t.selectClient||"operator"==t.vehicleSelect)&&t.month==e.filter.month&&t.year==e.filter.year});a.resolve(r)}else l.getRequest("regular",'q={"$or":[{"selectClient":"operator"},{"vehicleSelect":"operator"}],"month":"'+e.filter.month+'","year":"'+e.filter.year+'"}').then(function(e){a.resolve(e.data)});return a.promise},u=function(){var a=t.defer();if(l.request.fixed){var r=l.request.fixed.filter(function(t){return"operator"==t.vehicleSelect&&t.month==e.filter.month&&t.year==e.filter.year});a.resolve(r)}else l.getRequest("fixed",'q={"vehicleSelect":"operator","month":"'+e.filter.month+'","year":"'+e.filter.year+'"}').then(function(e){a.resolve(e.data)});return a.promise},d=function(e){var t=0,r=a("filter")(i,{selectClient:"operator",operatorName:e.name});e.totalInReq=r.length;for(var n=0;n<r.length;n++)t+=r[n].totalAmt+r[n].tollAmt+r[n].parkingAmt+r[n].driverOverTime-(r[n].advanceAmt?r[n].advanceAmt:0);return t},p=function(e){var t=0,r=a("filter")(i,{vehicleSelect:"operator",operator:{operatorName:e.name}}),n=a("filter")(c,{vehicleSelect:"operator",operator:{operatorName:e.name}});e.totalOutReq=r.length+n.length;for(var l=0;l<r.length;l++)t+=r[l].ownerTotal+r[l].tollAmt+r[l].parkingAmt+r[l].driverOverTime;for(var l=0;l<n.length;l++)t=t+n[l].totalAmt+n[l].tollAmt+n[l].parkingAmt+n[l].driverOverTime;return t},h=function(e){for(var t=[],r=0;r<e.length;r++){var n=[r+1,e[r].name,e[r].totalInReq,e[r].totalOutReq,a("number")(e[r].paymentIn,"2")+"/-",a("number")(e[r].paymentOut,"2")+"/-",a("number")(e[r].diff,"2")+"/-"];t.push(n)}return t};e.calculatePayment=function(){e.data=[],e.loading=!0,t.all([s(),u()]).then(function(t){i=t[0],c=t[1],angular.forEach(e.operatorList,function(e){e.paymentIn=d(e),e.paymentOut=p(e),e.diff=e.paymentIn-e.paymentOut}),e.data=e.operatorList,e.loading=!1})},e.getOperatorDetail=function(e,t){console.log(e),console.log(t)},e.exportData=function(){var t=["Sr.No","Operator Name","Out Bound Requests","In Bound Requests","Payment In","Payment Out","Difference"];o.buildPDF(t,h(e.data),"Operator Payment - "+e.filter.month+" "+e.filter.year,"Operator_Payment_"+e.filter.month+"_"+e.filter.year,0)},n.getParty("operator").then(function(t){e.operatorList=t.data[0].data,e.calculatePayment()})}]),app.controller("paymentController",["$scope",function(e){}]),app.controller("registerController",["$scope",function(e){}]),app.controller("allListController",["$scope","$state","$rootScope","$q","$filter","config","requestService","vehicleService","driverService","partyService","messageService","pdfService",function(e,t,a,r,n,l,o,i,c,s,u,d){e.data=[],e.localEnv=l.local,e.loading=!0,e.currMonth=(new Date).getMonth(),e.monthList=l.months;var p;e.filter={type:"party"},e.filter.month=e.monthList[e.currMonth];var h=function(){r.all([o.getRequest("regular",'s={"startTrip.date":-1}'),o.getRequest("fixed",'s={"date":-1}'),i.getVehicle("own"),c.getDriver(),s.getParty("client")]).then(function(t){e.loading=!1,y(t[0].data,t[1].data),v(t[2].data),g(t[3].data),m(t[4].data)},function(){t.go("login")})},f=function(){e.loading=!1,e.totalItems=e.data.length,e.currentPage=o.request.pager.currentPage,e.itemsPerPage=o.request.pager.itemsPerPage,e.maxSize=o.request.pager.maxSize},m=function(t){e.partyList=t[0].data,s.party.client||(s.party.client=t)},v=function(t){e.vehicleList=t[0].data,i.vehicle.own||(i.vehicle.own=t)},g=function(t){e.driverList=t,c.driver||(c.driver=t)},y=function(t,a){o.request.regular||(o.request.regular=t),o.request.fixed||(o.request.fixed=a);var r=[];angular.forEach(t,function(t,a){r.push({_id:e.localEnv?t._id:t._id.$oid,date:t.startTrip.date,request:"regular",requestType:"local"===t.requestType?"Local":"Out Station",client:"party"===t.selectClient?t.partyName:"operator"===t.selectClient?t.operatorName:t.userName,vehicle:"own"===t.vehicleSelect?t.vehicle.vehicle:"indirect"===t.vehicleSelect?t.inDirect.vehicle:"operator"===t.vehicleSelect?t.operator.vehicleName+","+t.operator.vehicleNo:t.agency.vehicleName+","+t.agency.vehicleNo,driver:"own"===t.vehicleSelect?t.vehicle.driver:"indirect"===t.vehicleSelect?t.inDirect.driver:"operator"===t.vehicleSelect?t.operator.driver:t.agency.driver,totalKm:t.totalKm,month:t.month,year:t.year})}),angular.forEach(a,function(t,a){r.push({_id:e.localEnv?t._id:t._id.$oid,date:t.date,request:"fixed",requestType:"local"===t.requestType?"Local":"Out Station",client:t.partyName,vehicle:"daily"===t.vehicleSelect?t.vehicle:"own"===t.vehicleSelect?t.own.vehicle:"indirect"===t.vehicleSelect?t.inDirect.vehicle:"operator"===t.vehicleSelect?t.operator.vehicleName+","+t.operator.vehicleNo:t.agency.vehicleName+","+t.agency.vehicleNo,driver:"daily"===t.vehicleSelect||"own"===t.vehicleSelect?t.driver:"indirect"===t.vehicleSelect?t.inDirect.driver:"operator"===t.vehicleSelect?t.operator.driver:t.agency.driver,totalKm:t.totalKm,month:t.month,year:t.year})}),e.data=n("orderBy")(r,"-date"),p=angular.copy(e.data),f()};h(),a.$on("fixedRequest",function(){h()}),a.$on("regularRequest",function(){h()}),e.applyFilter=function(){switch(e.filter.type){case"party":e.data=n("filter")(p,{client:e.filter.party,month:e.filter.month});break;case"vehicle":e.data=n("filter")(p,{vehicle:e.filter.vehicle,month:e.filter.month});break;case"driver":e.data=n("filter")(p,{driver:e.filter.driver,month:e.filter.month})}},e.clearFilter=function(){e.data=p,e.filter.type="party",e.filter.party="",e.filter.vehicle="",e.filter.driver="",e.filter.month=e.monthList[e.currMonth]},e.viewRequest=function(e,t){var a="regular"==e?"addRegularRequestController":"addFixedRequestController";o.viewRequest(e,"request/"+e+"/add-"+e+"-request.html",a,t)},e.editRequest=function(e,t){var a="regular"==e?"addRegularRequestController":"addFixedRequestController";o.editRequest(e,"request/"+e+"/add-"+e+"-request.html",a,t)},e.deleteRequest=function(t,a){u.deleteConfirm().result.then(function(r){r&&e.deleteRecord(t,a)})},e.deleteRecord=function(e,t){o.deleteRequest(e,t).then(function(t){o.request[e]=null,h(),u.showMessage({type:"success",title:e+" Request",text:e+" Request Deleted successfully."})},function(){u.showMessage({type:"error",title:e+" Request",text:e+" Request can not be deleted at this time. Please try again."})})},e.processForAllpdf=function(e){for(var t=[],a=0;a<e.length;a++){var r=[a+1,n("date")(e[a].date,"dd-MMM-yyyy"),e[a].request,e[a].requestType,e[a].client,e[a].vehicle,e[a].driver,e[a].totalKm+" KM"];t.push(r)}return t},e.exportData=function(){var t=["Sr. No","Date","Request","Request Type","Cliet Name","Vehicle","Driver","Total KM"];d.buildPDF(t,e.processForAllpdf(e.data),"All Requests","All_Requests")}}]),app.controller("addFixedRequestController",["$scope","$rootScope","$q","$filter","$uibModalInstance","requestService","vehicleService","driverService","partyService","packageService","messageService","record","calculation",function(e,t,a,r,n,l,o,i,c,s,u,d,p){"use strict";e.request=!0,e.request=!0,e.loading=!1,e.action=d.action;var h=new Date,f={vehicleSelect:"daily",requestType:"local",regularVehicle:"own",nightHaltAmt:0,date:h,diverAllowanceAmt:0,openingKm:0,closingKm:0,totalKm:0,startTime:"",totalHr:0,extraHr:0,own:{},inDirect:{},operator:{},agency:{},tollAmt:0,parkingAmt:0,totalAmt:0,driverOverTime:0},m=function(){a.all([o.getVehicle("own"),o.getVehicle("other"),i.getDriver(),c.getParty("client"),c.getParty("operator")]).then(function(t){e.vehicleList=t[0].data[0].data,o.vehicle.own||(o.vehicle.own=t[0].data),e.oVehicleList=t[1].data[0].data,o.vehicle.other||(o.vehicle.other=t[1].data),e.driverList=t[2].data,i.driver||(i.driver=t[2].data),e.partyList=t[3].data[0].data,c.party.client||(c.party.client=t[3].data),e.operatorList=t[4].data[0].data,c.party.operator||(c.party.operator=t[4].data),e.$watch("[requestData.regularVehicle,requestData.partyName]",function(t,a){switch(e.requestData.regularVehicle){case"indirect":e.regularVehicleList=r("filter")(e.oVehicleList,{selectFixed:"Yes",fixed:{companyName:e.requestData.partyName}});break;default:e.regularVehicleList=r("filter")(e.vehicleList,{selectFixed:"Yes",fixed:{companyName:e.requestData.partyName}})}e.regularVehicleList&&e.regularVehicleList.length>0&&"new"===e.action&&(e.requestData.vehicle=e.regularVehicleList[0].vehicleName+","+e.regularVehicleList[0].vehicleNo)}),e.$watch("requestData.operator.operatorName",function(t,a){e.requestData.operator.vehicle="",t&&(e.operatorVehicleList=r("filter")(e.operatorList,{name:t})[0].vehicle)}),e.$watch("requestData.requestType",function(t,a){s.getPackage(t).then(function(a){e.packageList=a.data[0].data,e.requestData.inDirect.ownerPackage="",e.requestData.inDirect.partyPackage="",e.requestData.agency.agencyPackage="",e.requestData.agency.partyPackage="",e.requestData.operator.operatorPackage="",e.requestData.operator.partyPackage="",s["package"][t]||(s["package"][t]=a.data)})})})};if("view"!==e.action&&m(),e.requestData="new"===d.action?f:d.data[0],"edit"==d.action){e.requestData.date=new Date(e.requestData.date),e.requestData.startTime=new Date(e.requestData.startTime),e.requestData.endTime=new Date(e.requestData.endTime);var v=e.requestData._id}e.hideView="view"===d.action,e.switchView=function(){e.request=!e.request},e.closeModal=function(){n.close()},e.calendar={},e.openCalendar=function(t){e.calendar[t]=!0},e.calculateTotalKm=function(){e.requestData.totalKm=e.requestData.closingKm-e.requestData.openingKm},e.calculateTotalHr=function(){if(e.requestData.totalHr=r("number")(e.calDuration()/36e5,"2"),e.requestData.extraHr=e.requestData.totalHr>12?e.requestData.totalHr-12:0,"out"===e.requestData.requestType){var t=Math.round(.4+e.calDuration()/864e5);e.requestData.totalDays=t<=0?1:t}else e.requestData.driverOverTime=20*e.requestData.extraHr},e.calDuration=function(){var t=e.requestData.date,a=e.requestData.startTime,r=e.requestData.date,n=e.requestData.endTime,l=t.getFullYear()+"/"+(t.getMonth()+1)+"/"+t.getDate(),o=a.getHours()+":"+a.getMinutes()+":"+a.getSeconds(),i=new Date(l+" "+o),c=r.getFullYear()+"/"+(r.getMonth()+1)+"/"+r.getDate(),s=n.getHours()+":"+n.getMinutes()+":"+n.getSeconds(),u=new Date(c+" "+s);return u-i},e.calculateOutTotal=function(t){var a=0,n=r("filter")(e.packageList,{packageCode:t})[0];a+=e.requestData.totalDays*n.basicAmt;var l=e.requestData.totalKm-n.kmRate.minKm*e.requestData.totalDays;return l>0&&(a+=l*n.kmRate.extraKm),a},e.calculateTotal=function(t){var a=0,n=r("filter")(e.packageList,{packageCode:t})[0];if(e.requestData.totalKm<=n.kmRate.minKm&&e.requestData.totalHr<=n.hrRate.minHr&&(a+=n.basicAmt),e.requestData.totalHr>n.hrRate.minHr&&e.requestData.totalKm<=n.kmRate.minKm){var l=Math.floor(e.requestData.totalHr/n.hrRate.minHr)*n.basicAmt,o=e.requestData.totalHr%n.hrRate.minHr*n.hrRate.extraHr;a+=l+o}if(e.requestData.totalKm>n.kmRate.minKm&&e.requestData.totalHr<=n.hrRate.minHr){var i=Math.floor(e.requestData.totalKm/n.kmRate.minKm)*n.basicAmt,c=e.requestData.totalKm%n.kmRate.minKm*n.kmRate.extraKm;a+=i+c}if(e.requestData.totalKm>n.kmRate.minKm&&e.requestData.totalHr>n.hrRate.minHr){var l=Math.floor(e.requestData.totalHr/n.hrRate.minHr)*n.basicAmt,o=e.requestData.totalHr%n.hrRate.minHr*n.hrRate.extraHr,c=e.requestData.totalKm%n.kmRate.minKm*n.kmRate.extraKm;a+=l+o+c}return a},e.calculate=function(){switch(e.requestData.vehicleSelect){case"indirect":"out"===e.requestData.requestType?e.requestData.totalAmt=e.calculateOutTotal(e.requestData.inDirect.ownerPackage):e.requestData.totalAmt=e.calculateTotal(e.requestData.inDirect.ownerPackage);break;case"operator":"out"===e.requestData.requestType?e.requestData.totalAmt=e.calculateOutTotal(e.requestData.operator.operatorPackage):e.requestData.totalAmt=e.calculateTotal(e.requestData.operator.operatorPackage);break;case"other":"out"===e.requestData.requestType?e.requestData.totalAmt=e.calculateOutTotal(e.requestData.agency.agencyPackage):e.requestData.totalAmt=e.calculateTotal(e.requestData.agency.agencyPackage)}},e.submitRequest=function(){e.loading=!0,"operator"===e.requestData.vehicleSelect&&(e.requestData.operator.vehicleName=e.requestData.operator.vehicle.split(",")[0],e.requestData.operator.vehicleNo=e.requestData.operator.vehicle.split(",")[1]),e.requestData.month=r("date")(e.requestData.date,"MMM"),e.requestData.year=r("date")(e.requestData.date,"yyyy"),"new"===e.action?l.addRequest("fixed",e.requestData).then(function(a){e.closeModal(),l.request.fixed=null,t.$emit("fixedRequest"),u.showMessage({type:"success",title:"Fixed Request",text:"New fixed request added successfully."})},function(){e.closeModal(),u.showMessage({type:"error",title:"Fixed Request",text:"New fixed request not added successfully. Please try again."})}):(delete e.requestData._id,l.updateRequest("fixed",v,JSON.parse(angular.toJson(e.requestData))).then(function(a){e.closeModal(),l.request.fixed=null,t.$emit("fixedRequest"),u.showMessage({type:"success",title:"Fixed Request",text:"Fixed request Updated successfully."})},function(){e.closeModal(),u.showMessage({type:"error",title:"Fixed Request",text:"Fixed not Updated successfully. Please try again."})}))}}]),app.controller("fixedListController",["$scope","$state","$rootScope","$filter","requestService","config","partyService","messageService","pdfService",function(e,t,a,r,n,l,o,i,c){e.data=[],e.localEnv=l.local,e.loading=!0,e.currMonth=(new Date).getMonth(),e.monthList=l.months;var s;e.filter={type:"party"},e.filter.month=e.monthList[e.currMonth];var u=function(){e.loading=!1,e.totalItems=e.data.length,e.currentPage=n.request.pager.currentPage,e.itemsPerPage=n.request.pager.itemsPerPage,e.maxSize=n.request.pager.maxSize},d=function(t){e.data=t.data,s=angular.copy(e.data),n.request.fixed||(n.request.fixed=t.data),u()},p=function(){n.getRequest("fixed",'s={"date":-1}').then(d)};o.getParty("client").then(function(t){e.partyList=t.data[0].data,o.party.client||(o.party.client=t.data),p()},function(){t.go("login")}),a.$on("fixedRequest",function(){p()}),e.applyFilter=function(){e.data=r("filter")(s,{partyName:e.filter.party,month:e.filter.month})},e.clearFilter=function(){e.data=s,e.filter.party="",e.filter.month=e.monthList[e.currMonth]},e.newRequest=function(e,t){n.newRequest("fixed",e,t)},e.viewRequest=function(e,t,a){n.viewRequest("fixed",e,t,a)},e.editRequest=function(e,t,a){n.editRequest("fixed",e,t,a)},e.deleteRequest=function(t){i.deleteConfirm().result.then(function(a){a&&e.deleteRecord(t)})},e.deleteRecord=function(e){n.deleteRequest("fixed",e).then(function(e){n.request.fixed=null,p(),i.showMessage({type:"success",title:"Fixed Request",text:"Fixed Request Deleted successfully."})},function(){i.showMessage({type:"error",title:"Fixed Request",text:"Fixed Request can not be deleted at this time. Please try again."})})},e.processForFixedpdf=function(e){for(var t=[],a=0;a<e.length;a++){var n=[a+1,r("date")(e[a].date,"dd-MMM-yyyy"),e[a].partyName,"local"===e[a].requestType?"Local":"Out Station",e[a].vehicleSelect,"daily"===e[a].vehicleSelect?e[a].vehicle:"own"===e[a].vehicleSelect?e[a].own.vehicle:"indirect"===e[a].vehicleSelect?e[a].inDirect.vehicle:"operator"===e[a].vehicleSelect?e[a].operator.vehicleName+","+e[a].operator.vehicleNo:e[a].agency.vehicleName+","+e[a].agency.vehicleNo,"daily"===e[a].vehicleSelect||"own"===e[a].vehicleSelect?e[a].driver:"indirect"===e[a].vehicleSelect?e[a].inDirect.driver:"operator"===e[a].vehicleSelect?e[a].operator.driver:e[a].agency.driver,e[a].totalKm+" KM",e[a].extraHr];t.push(n)}return t},e.exportData=function(){var t=["Sr. No","Date","Client Name","Request Type","Vehicle Provided","Vehicle","Driver","Total KM","Extra HR"];c.buildPDF(t,e.processForFixedpdf(e.data),"Fixed Requests","Fixed_Requests")}}]),app.controller("addRegularRequestController",["$scope","$rootScope","$q","$filter","$uibModalInstance","requestService","vehicleService","driverService","partyService","packageService","messageService","record","calculation",function(e,t,a,r,n,l,o,i,c,s,u,d,p){"use strict";e.request=!0,e.loading=!1,e.action=d.action;var h=new Date,f={requestType:"local",selectClient:"party",vehicleSelect:"own",startTrip:{date:h},endTrip:{date:h},openingKm:0,closingKm:0,totalKm:0,totalHr:0,totalDays:0,vehicle:{AC:"Yes"},inDirect:{AC:"Yes"},operator:{AC:"Yes"},agency:{AC:"Yes"},driverAllowance:0,advanceAmt:0,driverOverTime:0,tollAmt:0,parkingAmt:0,totalAmt:0,ownerTotal:0,profit:0},m=function(){a.all([o.getVehicle("own"),o.getVehicle("other"),i.getDriver(),c.getParty("client"),c.getParty("operator")]).then(function(t){e.vehicleList=t[0].data[0].data,o.vehicle.own||(o.vehicle.own=t[0].data),e.oVehicleList=t[1].data[0].data,o.vehicle.other||(o.vehicle.other=t[1].data),e.driverList=t[2].data,i.driver||(i.driver=t[2].data),e.partyList=t[3].data[0].data,c.party.client||(c.party.client=t[3].data),e.operatorList=t[4].data[0].data,c.party.operator||(c.party.operator=t[4].data),e.$watch("requestData.operator.operatorName",function(t,a){e.requestData.operator.vehicle="",t&&(e.operatorVehicleList=r("filter")(e.operatorList,{name:t})[0].vehicle)}),e.$watch("requestData.requestType",function(t,a){s.getPackage(t).then(function(a){e.packageList=a.data[0].data,s["package"][t]||(s["package"][t]=a.data)})})})};if("view"!==e.action&&m(),e.requestData="new"===e.action?f:d.data[0],"edit"==d.action){e.requestData.startTrip.date=new Date(e.requestData.startTrip.date),e.requestData.endTrip.date=new Date(e.requestData.endTrip.date),e.requestData.startTrip.time=new Date(e.requestData.startTrip.time),e.requestData.endTrip.time=new Date(e.requestData.endTrip.time);var v=e.requestData._id}e.hideView="view"===d.action,e.switchView=function(){e.request=!e.request},e.closeModal=function(){n.close()},e.calendar={},e.openCalendar=function(t){e.calendar[t]=!0},e.calculateTotalKm=function(){e.requestData.totalKm=e.requestData.closingKm-e.requestData.openingKm},e.calculateTotalHr=function(){e.requestData.totalHr=p.duration(e.requestData.startTrip.date,e.requestData.endTrip.date,e.requestData.startTrip.time,e.requestData.endTrip.time)/36e5,e.requestData.totalHr=r("number")(e.requestData.totalHr,"2")},e.calculateTotalDays=function(){var t=Math.round(.4+p.duration(e.requestData.startTrip.date,e.requestData.endTrip.date,e.requestData.startTrip.time,e.requestData.endTrip.time)/864e5);e.requestData.totalDays=t<=0?1:t},e.calculateOutTotal=function(t,a){var n=0;e.requestData.driverOverTime=0;var l=r("filter")(e.packageList,{packageCode:t})[0];"party"===a&&(e.requestData.reqPackage=JSON.parse(angular.toJson(l))),n+=e.requestData.totalDays*l.basicAmt;var o=e.requestData.totalKm-l.kmRate.minKm*e.requestData.totalDays;return o>0&&(n+=o*l.kmRate.extraKm),n},e.calculateTotal=function(t,a){var n=0,l=r("filter")(e.packageList,{
packageCode:t})[0];if("party"===a&&(e.requestData.reqPackage=JSON.parse(angular.toJson(l))),e.requestData.totalKm<=l.kmRate.minKm&&e.requestData.totalHr<=l.hrRate.minHr&&(e.requestData.driverOverTime=0,n+=l.basicAmt),e.requestData.totalHr>l.hrRate.minHr&&e.requestData.totalKm<=l.kmRate.minKm){var o=Math.floor(e.requestData.totalHr/l.hrRate.minHr)*l.basicAmt,i=e.requestData.totalHr%l.hrRate.minHr*l.hrRate.extraHr;e.requestData.driverOverTime=e.requestData.totalHr%12*20,n+=o+i}if(e.requestData.totalKm>l.kmRate.minKm&&e.requestData.totalHr<=l.hrRate.minHr){var c=Math.floor(e.requestData.totalKm/l.kmRate.minKm)*l.basicAmt,s=e.requestData.totalKm-l.kmRate.minKm,u=s>0?s*l.kmRate.extraKm:0;e.requestData.driverOverTime=0,n+=c+u}if(e.requestData.totalKm>l.kmRate.minKm&&e.requestData.totalHr>l.hrRate.minHr){var o=Math.floor(e.requestData.totalHr/l.hrRate.minHr)*l.basicAmt,i=e.requestData.totalHr%l.hrRate.minHr*l.hrRate.extraHr,s=e.requestData.totalKm-l.kmRate.minKm,u=s>0?s*l.kmRate.extraKm:0;e.requestData.driverOverTime=e.requestData.totalHr%12*20,n+=o+i+u}return n},e.calculate=function(){switch(e.requestData.vehicleSelect){case"own":"out"===e.requestData.requestType?e.requestData.totalAmt=e.calculateOutTotal(e.requestData.vehicle.partyPackage,"party"):e.requestData.totalAmt=e.calculateTotal(e.requestData.vehicle.partyPackage,"party"),e.requestData.profit=e.requestData.totalAmt-e.requestData.driverAllowance-e.requestData.driverOverTime;break;case"indirect":"out"===e.requestData.requestType?(e.requestData.totalAmt=e.calculateOutTotal(e.requestData.inDirect.partyPackage,"party"),e.requestData.ownerTotal=e.calculateOutTotal(e.requestData.inDirect.ownerPackage,"owner"),e.requestData.profit=e.requestData.totalAmt-e.requestData.ownerTotal):(e.requestData.totalAmt=e.calculateTotal(e.requestData.inDirect.partyPackage,"party"),e.requestData.ownerTotal=e.calculateTotal(e.requestData.inDirect.ownerPackage,"owner"),e.requestData.profit=e.requestData.totalAmt-e.requestData.ownerTotal);break;case"operator":"out"===e.requestData.requestType?(e.requestData.totalAmt=e.calculateOutTotal(e.requestData.operator.partyPackage,"party"),e.requestData.ownerTotal=e.calculateOutTotal(e.requestData.operator.operatorPackage,"owner"),e.requestData.profit=e.requestData.totalAmt-e.requestData.ownerTotal):(e.requestData.totalAmt=e.calculateTotal(e.requestData.operator.partyPackage,"party"),e.requestData.ownerTotal=e.calculateTotal(e.requestData.operator.operatorPackage,"owner"),e.requestData.profit=e.requestData.totalAmt-e.requestData.ownerTotal);break;case"other":"out"===e.requestData.requestType?(e.requestData.totalAmt=e.calculateOutTotal(e.requestData.agency.partyPackage,"party"),e.requestData.ownerTotal=e.calculateOutTotal(e.requestData.agency.agencyPackage,"owner"),e.requestData.profit=e.requestData.totalAmt-e.requestData.ownerTotal):(e.requestData.totalAmt=e.calculateTotal(e.requestData.agency.partyPackage,"party"),e.requestData.ownerTotal=e.calculateTotal(e.requestData.agency.agencyPackage,"owner"),e.requestData.profit=e.requestData.totalAmt-e.requestData.ownerTotal)}},e.submitRequest=function(){e.loading=!0,"operator"===e.requestData.vehicleSelect&&(e.requestData.operator.vehicleName=e.requestData.operator.vehicle.split(",")[0],e.requestData.operator.vehicleNo=e.requestData.operator.vehicle.split(",")[1]),e.requestData.month=r("date")(e.requestData.startTrip.date,"MMM"),e.requestData.year=r("date")(e.requestData.startTrip.date,"yyyy"),"new"===e.action?l.addRequest("regular",e.requestData).then(function(a){e.closeModal(),l.request.regular=null,t.$emit("regularRequest"),u.showMessage({type:"success",title:"Regular Request",text:"New regular request added successfully."})},function(){e.closeModal(),u.showMessage({type:"error",title:"Regular Request",text:"New regular request not added successfully. Please try again."})}):(delete e.requestData._id,l.updateRequest("regular",v,JSON.parse(angular.toJson(e.requestData))).then(function(a){e.closeModal(),l.request.regular=null,t.$emit("regularRequest"),u.showMessage({type:"success",title:"Regular Request",text:"Regular request Updated successfully."})},function(){e.closeModal(),u.showMessage({type:"error",title:"Regular Request",text:"Request not Updated successfully. Please try again."})}))}}]),app.controller("regularListController",["$scope","$state","$rootScope","$q","$filter","requestService","config","messageService","vehicleService","driverService","pdfService",function(e,t,a,r,n,l,o,i,c,s,u){e.data=[],e.localEnv=o.local,e.loading=!0,e.currMonth=(new Date).getMonth(),e.monthList=o.months,e.filter={type:"vehicle"},e.filter.month=e.monthList[e.currMonth];var d,p=function(){e.loading=!1,e.totalItems=e.data.length,e.currentPage=l.request.pager.currentPage,e.itemsPerPage=l.request.pager.itemsPerPage,e.maxSize=l.request.pager.maxSize},h=function(t){e.data=t.data,d=angular.copy(e.data),l.request.regular||(l.request.regular=t.data),p()},f=function(){l.getRequest("regular",'s={"startTrip.date":-1}').then(h)};r.all([c.getVehicle("own"),s.getDriver()]).then(function(t){e.vehicleList=t[0].data[0].data,c.vehicle.own||(c.vehicle.own=t[0].data),e.driverList=t[1].data,s.driver||(s.driver=t[1].data),f()},function(){t.go("login")}),a.$on("regularRequest",function(){f()}),e.applyFilter=function(){"vehicle"===e.filter.type?e.data=n("filter")(d,{vehicleSelect:"own",vehicle:{vehicle:e.filter.vehicle},month:e.filter.month}):"driver"===e.filter.type&&(e.data=n("filter")(d,{vehicleSelect:"own",vehicle:{driver:e.filter.driver},month:e.filter.month}))},e.clearFilter=function(){e.data=d,e.filter.type="vehicle",e.filter.vehicle="",e.filter.driver="",e.filter.month=e.monthList[e.currMonth]},e.newRequest=function(e,t){l.newRequest("regular",e,t)},e.viewRequest=function(e,t,a){l.viewRequest("regular",e,t,a)},e.editRequest=function(e,t,a){l.editRequest("regular",e,t,a)},e.deleteRequest=function(t){i.deleteConfirm().result.then(function(a){a&&e.deleteRecord(t)})},e.deleteRecord=function(e){l.deleteRequest("regular",e).then(function(e){l.request.regular=null,f(),i.showMessage({type:"success",title:"Regular Request",text:"Regular Request Deleted successfully."})},function(){i.showMessage({type:"error",title:"Regular Request",text:"Regular Request can not be deleted at this time. Please try again."})})},e.processForpdf=function(e){for(var t=[],a=0;a<e.length;a++){var r=[a+1,n("date")(e[a].startTrip.date,"dd-MMM-yyyy"),"party"===e[a].selectClient?e[a].partyName:"operator"===e[a].selectClient?e[a].operatorName:e[a].userName,"local"===e[a].requestType?"Local":"Out Station",n("date")(e[a].endTrip.date,"dd-MMM-yyyy"),"own"===e[a].vehicleSelect?e[a].vehicle.driver:"indirect"===e[a].vehicleSelect?e[a].inDirect.driver:"operator"===e[a].vehicleSelect?e[a].operator.driver:e[a].agency.driver,"own"===e[a].vehicleSelect?e[a].vehicle.vehicle:"indirect"===e[a].vehicleSelect?e[a].inDirect.vehicle:"operator"===e[a].vehicleSelect?e[a].operator.vehicleName:e[a].agency.vehicleName,e[a].totalKm+" KM",n("number")(e[a].totalAmt,"2")+"/-"];t.push(r)}return t},e.exportData=function(){var t=["Sr. No","Start Date","Client Name","Request Type","End Date","Driver Name","Vehicle","Total KM","Total Amt"];u.buildPDF(t,e.processForpdf(e.data),"Regular Requests","Regular_Requests",8)}}]),app.controller("requestController",["$scope",function(e){}]),app.factory("requestService",["$uibModal","$filter","$q","config",function(e,t,a,r){return{request:{regular:null,fixed:null,pager:{currentPage:1,itemsPerPage:15,maxSize:5}},filterRequest:function(e,a){return t("filter")(this.request[e],{_id:r.local?a:{$oid:a}})},getRequest:function(e,t){return this.request[e]?a.resolve({data:this.request[e]}):r.getData(r[e],t)},addRequest:function(e,t){return r.postData(r[e],t)},updateRequest:function(e,t,a){var n=r.local?'{"_id":"'+t+'"}':'{"_id":{"$oid":"'+t.$oid+'"}}';return r.updateData(r[e],n,{$set:a})},deleteRequest:function(e,t){return r.deleteData(r[e],t)},newRequest:function(t,a,r){e.open({templateUrl:a,controller:r,size:"lg",resolve:{record:function(){return{type:t,action:"new"}}}})},editRequest:function(t,a,r,n){var l=this;e.open({templateUrl:a,controller:r,size:"lg",resolve:{record:function(){return{type:t,action:"edit",data:l.filterRequest(t,n)}}}})},viewRequest:function(t,a,r,n){var l=this;e.open({templateUrl:a,controller:r,size:"lg",resolve:{record:function(){return{type:t,action:"view",data:l.filterRequest(t,n)}}}})}}}]),app.controller("driverSummaryController",["$scope","$state","$filter","$q","config","driverService","requestService","expenseService",function(e,t,a,r,n,l,o,i){e.yearList=n.years(),sessionStorage.getItem("year")?e.year=sessionStorage.getItem("year"):e.year=(new Date).getFullYear().toString();var c=n.months,s={local:[],out:[]},u=function(){e.loading=!0,l.getDriver().then(function(t){e.driverList=t.data,sessionStorage.getItem("driver")?e.driverSelect=sessionStorage.getItem("driver"):e.driverSelect=e.driverList[0].name,d(),l.driver||(l.driver=t.data)})},d=function(){o.request.regular=null,o.request.fixed=null,r.all([o.getRequest("regular",'q={"year":"'+e.year+'", "vehicleSelect":"own","vehicle.driver":"'+e.driverSelect+'"}&f={"requestType":1,"profit":1,"month":1}'),o.getRequest("fixed",'q={"$or":[{"regularVehicle":"own","vehicleSelect":"daily"},{"regularVehicle":"own","vehicleSelect":"own"},{"regularVehicle":"indirect","vehicleSelect":"own"}],"driver":"'+e.driverSelect+'","year":"'+e.year+'"}')]).then(function(e){for(var t=0;t<c.length;t++)s.local.push(a("filter")(e[0].data,{month:c[t],requestType:"local"}).length+a("filter")(e[1].data,{month:c[t],requestType:"local"}).length),s.out.push(a("filter")(e[0].data,{month:c[t],requestType:"out"}).length+a("filter")(e[1].data,{month:c[t],requestType:"out"}).length);p()})},p=function(){e.loading=!1,angular.forEach(s,function(e,t){new Chart(document.getElementById(t),{type:"bar",data:{labels:n.months,datasets:[{label:t.toUpperCase()+" ",backgroundColor:"rgba(54,162,235,0.2)",borderColor:"rgba(54,162,235,1)",borderWidth:.5,hoverBackgroundColor:"rgba(54,162,235,0.4)",hoverBorderColor:"rgba(54,162,235,1)",data:e}]}})}),sessionStorage.removeItem("driver"),sessionStorage.removeItem("year")};u(),e.redrawGraph=function(){sessionStorage.setItem("driver",e.driverSelect),sessionStorage.setItem("year",e.year),t.reload()}}]),app.controller("summaryController",["$scope",function(e){}]),app.controller("vehicleSummaryController",["$scope","$state","$filter","config","vehicleService","requestService","expenseService",function(e,t,a,r,n,l,o){e.yearList=r.years(),sessionStorage.getItem("year")?e.year=sessionStorage.getItem("year"):e.year=(new Date).getFullYear().toString();var i=r.months,c={local:[],out:[],income:[],expense:[]},s=function(){e.loading=!0,n.getVehicle("own").then(function(t){e.vehicleList=t.data[0].data,sessionStorage.getItem("veh")?e.vehicleSelect=sessionStorage.getItem("veh"):e.vehicleSelect=e.vehicleList[0].vehicleName+","+e.vehicleList[0].vehicleNo,u(),n.vehicle.own||(n.vehicle.own=t.data)})},u=function(){l.request.regular=null,l.getRequest("regular",'q={"year":"'+e.year+'", "vehicleSelect":"own","vehicle.vehicle":"'+e.vehicleSelect+'"}&f={"requestType":1,"profit":1,"month":1}').then(function(e){for(var t=0;t<i.length;t++)c.local.push(a("filter")(e.data,{month:i[t],requestType:"local"}).length),c.out.push(a("filter")(e.data,{month:i[t],requestType:"out"}).length),d(a("filter")(e.data,{month:i[t]}));p()})},d=function(e){for(var t=0,a=0;a<e.length;a++)t+=e[a].profit;c.income.push(t)},p=function(){o.getExpense("vehicleExpense",'q={"year":"'+e.year+'", "vehicle":"'+e.vehicleSelect+'"}&f={"expenseAmt":1,"month":1}').then(function(e){for(var t=0;t<i.length;t++)h(a("filter")(e.data,{month:i[t]}));f()})},h=function(e){for(var t=0,a=0;a<e.length;a++)t+=e[a].expenseAmt;c.expense.push(t)},f=function(){e.loading=!1,angular.forEach(c,function(e,t){new Chart(document.getElementById(t),{type:"bar",data:{labels:r.months,datasets:[{label:t.toUpperCase()+" ",backgroundColor:"rgba(54,162,235,0.2)",borderColor:"rgba(54,162,235,1)",borderWidth:.5,hoverBackgroundColor:"rgba(54,162,235,0.4)",hoverBorderColor:"rgba(54,162,235,1)",data:e}]}})}),sessionStorage.removeItem("veh"),sessionStorage.removeItem("year")};s(),e.redrawGraph=function(){sessionStorage.setItem("veh",e.vehicleSelect),sessionStorage.setItem("year",e.year),t.reload()}}]),app.controller("otherVehicleController",["$scope","$rootScope","$uibModal","vehicleService","messageService","gridMap",function(e,t,a,r,n,l){e.data=[],e.gridConfig=l.VEHICLE.OTHER,e.loading=!0;var o=function(t){e.data=t.data[0].data,r.vehicle.other||(r.vehicle.other=t.data),e.loading=!1},i=function(){r.getVehicle("other").then(o)},c=function(e,t){a.open({templateUrl:"vehicle/vehicle-modal.html",controller:"vehicleModalController",size:"lg",resolve:{record:function(){return{action:e,type:"other",data:t}}}})};t.$on("otherVehicle",function(){i()}),i(),e.newVehicle=function(){c("new",{})},e.view=function(e){c("view",r.filterRecord("other",e)[0])},e.edit=function(e){c("edit",r.filterRecord("other",e)[0])},e["delete"]=function(t){n.deleteConfirm().result.then(function(a){a&&e.deleteRecord(t)})},e.deleteRecord=function(e){var t=r.filterRecord("other",e)[0].vehicleName;r.deleteVehicle('{"name":"other"}',e).then(function(){r.vehicle.other=null,i(),n.showMessage({type:"success",title:"Vehicle",text:"Vehicle "+t+" Deleted successfully."})},function(){n.showMessage({type:"error",title:"Vehicle",text:"vehicle "+t+" can not be deleted at this time. Please try again."})})}}]),app.controller("ownVehicleController",["$scope","$state","$rootScope","$uibModal","vehicleService","messageService","gridMap",function(e,t,a,r,n,l,o){e.data=[],e.gridConfig=o.VEHICLE.OWN,e.loading=!0;var i=function(t){e.data=t.data[0].data,n.vehicle.own||(n.vehicle.own=t.data),e.loading=!1},c=function(){n.getVehicle("own").then(i,function(){t.go("login")})},s=function(e,t){r.open({templateUrl:"vehicle/vehicle-modal.html",controller:"vehicleModalController",size:"lg",resolve:{record:function(){return{action:e,type:"own",data:t}}}})};a.$on("ownVehicle",function(){c()}),c(),e.newVehicle=function(){s("new",{})},e.view=function(e){s("view",n.filterRecord("own",e)[0])},e.edit=function(e){s("edit",n.filterRecord("own",e)[0])},e["delete"]=function(t){l.deleteConfirm().result.then(function(a){a&&e.deleteRecord(t)})},e.deleteRecord=function(e){var t=n.filterRecord("own",e)[0].vehicleName;n.deleteVehicle('{"name":"own"}',e).then(function(){n.vehicle.own=null,c(),l.showMessage({type:"success",title:"Vehicle",text:"Vehicle "+t+" Deleted successfully."})},function(){l.showMessage({type:"error",title:"Vehicle",text:"vehicle "+t+" can not be deleted at this time. Please try again."})})}}]),app.controller("vehicleController",["$scope",function(e){}]),app.controller("vehicleModalController",["$scope","$q","$rootScope","$uibModalInstance","vehicleService","packageService","partyService","messageService","record",function(e,t,a,r,n,l,o,i,c){"use strict";e.vehicleView=!0;var s=new Date;e.vehicle=angular.copy(c.data),e.action=c.action,e.type=c.type,e.loading=!1,e.hideView="view"===e.action,"new"===e.action&&(e.vehicle.vehicleType="Car",e.vehicle.AC="Yes",e.vehicle.selectLoan="No",e.vehicle.selectFixed="No",e.vehicle.fixed={contractStartDate:s,contractEndDate:s},"own"===e.type&&(e.vehicle.loan={loanDisbursementDate:s,emiDate:s},e.vehicle.documents={PUC:{startDate:s,endDate:s,amt:0},tax:{startDate:s,endDate:s,amt:0},passing:{startDate:s,endDate:s,amt:0},permit:{startDate:s,endDate:s,amt:0},authorization:{startDate:s,endDate:s,amt:0},insurance:{startDate:s,endDate:s,amt:0}})),t.all([l.getPackage("fix"),o.getParty("client")]).then(function(t){e.packageList=t[0].data[0].data,l["package"].fix||(l["package"].fix=t[0].data),e.partyList=t[1].data[0].data,o.party.client||(o.party.client=t[1].data)}),"edit"===e.action&&("Yes"==e.vehicle.selectLoan&&(e.vehicle.loan.loanDisbursementDate=new Date(e.vehicle.loan.loanDisbursementDate),e.vehicle.loan.emiDate=new Date(e.vehicle.loan.emiDate)),"Yes"==e.vehicle.selectFixed&&(e.vehicle.fixed.contractStartDate=new Date(e.vehicle.fixed.contractStartDate),e.vehicle.fixed.contractEndDate=new Date(e.vehicle.fixed.contractEndDate)),angular.forEach(e.vehicle.documents,function(e){e.startDate=new Date(e.startDate),e.endDate=new Date(e.endDate)})),e.switchView=function(){e.vehicleView=!e.vehicleView},e.calendar={},e.endCalendar={},e.openCalendar=function(t){e.calendar[t]=!0},e.openEndCalendar=function(t){e.endCalendar[t]=!0},e.closeModal=function(){r.close()},e.submitRequest=function(){e.loading=!0,"new"===c.action?n.addVehicle('{"name":"'+e.type+'"}',e.vehicle).then(function(){e.closeModal(),n.vehicle[e.type]=null,a.$emit(e.type+"Vehicle"),i.showMessage({type:"success",title:"Vehicle",text:"New "+e.type+" vehicle added successfully."})},function(){i.showMessage({type:"error",title:"Vehicle",text:e.type+" vehicle not added successfully. Please try again."})}):n.updateVehicle('{"name":"'+e.type+'","data._id":"'+e.vehicle._id+'"}',e.vehicle).then(function(){e.closeModal(),n.vehicle[e.type]=null,a.$emit(e.type+"Vehicle"),i.showMessage({type:"success",title:"Vehicle",text:"New "+e.type+" vehicle updated successfully."})},function(t){i.showMessage({type:"error",title:"Vehicle",text:e.type+" vehicle not updated successfully. Please try again."})})}}]),app.factory("vehicleService",["$uibModal","$filter","$q","config",function(e,t,a,r){return{vehicle:{own:null,other:null},filterRecord:function(e,a){return t("filter")(this.vehicle[e][0].data,{_id:a})},getVehicle:function(e){return this.vehicle[e]?a.resolve({data:this.vehicle[e]}):r.getData(r.vehicle,'q={"name":"'+e+'"}')},addVehicle:function(e,t){return t._id=r.guid(),r.updateData(r.vehicle,e,{$push:{data:t}})},updateVehicle:function(e,t){return r.updateData(r.vehicle,e,{$set:{"data.$":t}})},deleteVehicle:function(e,t){var a={_id:t};return r.updateData(r.vehicle,e,{$pull:{data:a}})}}}]);